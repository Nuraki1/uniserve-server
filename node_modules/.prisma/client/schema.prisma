generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  admin
  cashier
  kitchen
  waiter
}

enum OrderStatus {
  pending
  accepted
  preparing
  prepared
  completed
  paid
}

enum PaymentMethod {
  cash
  card
  bank
  prepaid
  credit
}

enum CustomerAccountType {
  prepaid
  credit
  regular
}

enum PermissionRole {
  Cashier
  Kitchen
  Waiter
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  name         String
  role         UserRole
  branchId     String?
  avatarUrl    String?  @db.LongText
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([role, branchId])
}

model Branch {
  // Use a human/stable id (e.g. "furi", "sarbet") to match existing frontend branchId usage.
  id        String   @id
  name      String
  location  String?
  phone     String?
  manager   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model MenuItem {
  id          String  @id @default(uuid())
  name        String
  category    String
  price       Float
  description String? @db.LongText
  available   Boolean @default(true)
  imageUrl    String? @db.LongText
  branchId    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([branchId, category])
  @@index([available])
}

model Customer {
  id          String              @id @default(uuid())
  name        String
  phone       String?
  email       String?
  notes       String?             @db.LongText
  branchId    String?
  accountType CustomerAccountType @default(regular)
  balance     Float               @default(0)
  creditLimit Float?
  creditUsed  Float?
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  @@index([branchId, createdAt])
}

model Table {
  id        String   @id @default(uuid())
  number    String
  capacity  Int
  section   String?
  branchId  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([branchId, number])
  @@index([branchId])
}

model RolePermissions {
  id        Int            @id @default(autoincrement())
  role      PermissionRole @unique
  sections  Json
  actions   Json
  updatedAt DateTime       @updatedAt
  createdAt DateTime       @default(now())
}

model CommonComment {
  id        String   @id @default(uuid())
  text      String
  category  String?
  branchId  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([branchId, category])
}

model Order {
  id          String      @id @default(uuid())
  orderNumber Int
  status      OrderStatus @default(pending)

  // Lightweight denormalized shape to match current frontend payloads
  items           Json
  table           String?
  customer        String?
  customerId      String?
  waiter          String?
  waiterUserId    String?
  branchId        String?
  clientRequestId String? @unique

  subtotal      Float
  tax           Float
  discount      Float
  total         Float
  paymentMethod PaymentMethod?
  bankType      String?

  preparedAt DateTime?
  paidAt     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([branchId, createdAt])
  @@index([status, createdAt])
}
